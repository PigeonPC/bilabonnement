<!DOCTYPE html>
<html lang="da" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Skadesrapport</title>

    <!-- DINE STYLES (uændret) -->
    <link rel="stylesheet" th:href="@{/css/basicStyle.css}">
    <link rel="stylesheet" th:href="@{/css/forms/damageReportForm.css}">
    <link rel="stylesheet" th:href="@{/css/searchBarAndGraphic.css}">
</head>
<body>

<!-- Header -->
<div th:replace="~{fragments/headerFragment :: header}"></div>

<!-- Søgebar + statusgrafik -->
<div class="search-area">
    <div th:replace="~{fragments/searchBarFragment :: searchBar(selectedVehicleId=${selectedVehicleId})}"></div>
    <div th:replace="~{fragments/statusGraphicFragment :: statusGraphic(statusImage=${statusImage})}"></div>
</div>

<div class="page-wrapper">

    <div class="top-header">Skadesrapport</div>

    <!-- Hele formularen binder til damageReport -->
    <form id="damageForm"
          th:action="@{/damageReportForm/save}"
          th:object="${damageReport}"
          method="post"
          class="damage-form">

        <!-- Skjult nøglefelt -->
        <input type="hidden" th:field="*{damageReportId}"/>

        <!-- ---------- Basisoplysninger ---------- -->
        <div class="form-grid">

            <div class="input-wrapper">
                <span>Lejekontrakt ID</span>
                <input id="leaseId" type="number" th:field="*{leasingContractId}">
            </div>

            <div class="input-wrapper">
                <span>Vehicle ID</span>
                <!-- Kun visning; controller lægger vehicleId i model separat -->
                <input id="vehicleReadonly" type="text" th:value="${vehicleId}" readonly>
            </div>

            <div class="input-wrapper">
                <span>Renter ID</span>
                <input id="renterReadonly" type="text" th:value="${renterId}" readonly>
            </div>

            <div class="input-wrapper">
                <span>Dato for rapport</span>
                <input id="reportDate" type="date" th:field="*{reportDate}">
            </div>

            <div class="input-wrapper">
                <span>Kilometertal</span>
                <input id="totalKm"
                       type="number"
                       th:field="*{totalKm}"
                       min="0" max="999999" inputmode="numeric"
                       th:classappend="${kmError != null} ? ' is-invalid' : ''">
            </div>
        </div>

        <div class="error" th:if="${kmError != null}" th:text="${kmError}"></div>

        <!-- ---------- Skader (liste) ---------- -->
        <div class="damage-section-box">
            <h3 class="damage-title">Skader</h3>

            <!-- Kolonne-overskrifter (én række) -->
            <div class="damage-row damage-header">
                <div class="damage-field id"><strong>Nr.</strong></div>
                <div class="damage-field description"><strong>Beskrivelse</strong></div>
                <div class="damage-field price"><strong>Pris</strong></div>
                <div class="damage-field deleteItem"><strong>Slet</strong></div>
            </div>

            <!-- Eksisterende skader + den tomme indtastningsrække (controller skal altid tilføje mindst én tom) -->
            <div class="damage-list" th:if="*{damageItems} != null">
                <div class="damage-row" th:each="item, iter : *{damageItems}">

                    <!-- Skjult item-id (null = ny/ikke gemt endnu) -->
                    <input type="hidden" th:field="*{damageItems[__${iter.index}__].damageItemId}"/>

                    <!-- Nr. (read-only, blot visning) -->
                    <div class="damage-field id">
                        <input type="text" th:value="${iter.index + 1}" readonly>
                    </div>

                    <!-- Beskrivelse -->
                    <div class="damage-field description">
                        <input type="text"
                               th:field="*{damageItems[__${iter.index}__].description}">
                    </div>

                    <!-- Pris -->
                    <div class="damage-field price">
                        <input type="number"
                               th:field="*{damageItems[__${iter.index}__].damageItemPrice}"
                               min="0" step="0.01" inputmode="decimal">
                    </div>

                    <!-- Slet-kolonne: ren checkbox uden farver/labels -->
                    <!-- Vi binder IKKE til model (for at undgå krav om ekstra felt) -->
                    <!-- I stedet sender vi indeks/id som alm. request-param, som controlleren selv kan rense efter. -->
                    <div class="damage-field deleteItem" style="align-items:center;justify-content:center;">
                        <!-- Hvis eksisterende række har id → slet efter id -->
                        <input th:if="${item.damageItemId != null}"
                               type="checkbox"
                               name="deleteIds"
                               th:value="${item.damageItemId}"/>

                        <!-- Hvis ny (ingen id endnu) → slet efter indeks -->
                        <input th:if="${item.damageItemId == null}"
                               type="checkbox"
                               name="deleteNewIndexes"
                               th:value="${iter.index}"/>
                    </div>
                </div>
            </div>

            <!-- Summen af skader (readonly i UI, men bundet i model) -->
            <div class="input-wrapper">
                <span>Pris i alt (skader)</span>
                <input id="totalDamagePrice" type="number" th:value="*{totalDamagePrice}" readonly disabled>
            </div>

            <div class="error" th:if="${priceError != null}" th:text="${priceError}"></div>
        </div>

        <!-- Tip-tekst: forklar “Gem” (ligger under skades-afsnittet) -->
        <p class="hint-text" style="margin: 0 0 20px; font-size: 0.95rem;">
            Tip: Efter du har tilføjet, redigeret eller markeret skader til sletning, skal du trykke
            <strong>Gem</strong> for at se den opdaterede rapport og for at kunne tilføje flere skader.
        </p>

        <!-- ---------- Afledte felter ---------- -->
        <div class="form-grid">
            <div class="input-wrapper">
                <span>Kørte kilometer</span>
                <input id="drivenKm" type="number" th:value="${drivenKm}" readonly>
            </div>

            <div class="input-wrapper">
                <span>Pris for ekstra km</span>
                <input id="extraKmPrice" type="number" th:value="${extraKmPrice}" readonly>
            </div>

            <div class="input-wrapper">
                <span>Pris i alt</span>
                <input id="totalPrice" type="number" th:field="*{totalPrice}" readonly>
            </div>
        </div>

        <!-- ---------- Betalt-status ---------- -->
        <div class="paid-section" style="margin-top: 10px;">
            <span>Betalt?</span>
            <label>
                <input type="radio" th:field="*{paidStatus}" value="true"> Ja
            </label>
            <label>
                <input type="radio" th:field="*{paidStatus}" value="false"> Nej
            </label>
        </div>

        <!-- ---------- Sen aflevering (200 kr ekstra) ---------- -->
        <div class="paid-section" style="margin-top: 10px;">
            <span>Afleveret for sent?</span>
            <label>
                <input type="radio" th:field="*{lateReturn}" value="true"> Ja
            </label>
            <label>
                <input type="radio" th:field="*{lateReturn}" value="false"> Nej
            </label>

            <!-- Kun en lille visuel note når lateReturn = true -->
            <div th:if="*{lateReturn}" class="input-wrapper" style="margin-top:10px;">
                <span>Sen aflevering (ekstra mdr. reg.afgift)</span>
                <input type="text" value="200.00" readonly />
            </div>
        </div>

        <!-- ---------- Knapper (klassenavne matcher din CSS) --------- -->
        <div class="action-buttons">
            <!-- Tilbage: GET til /damageDepartment -->
            <button class="back" type="submit"
                    formmethod="get"
                    th:formaction="@{/damageDepartment}">
                Tilbage
            </button>

            <!-- Gem: POST til /damageReportForm/save (formens action) -->
            <button class="save" type="submit">Gem</button>

            <!-- Opret ny: GET til /damageReportForm/new?vehicleId=... -->
            <button class="delete" type="submit"
                    formmethod="get"
                    th:formaction="@{/damageReportForm/new(vehicleId=${vehicleId})}">
                Opret ny
            </button>
        </div>

        <!-- Info-flag -->
        <div class="notice" th:if="${noLeaseForVehicle}">Ingen lejekontrakt for denne bil.</div>
        <div class="notice" th:if="${noReport}">Ingen eksisterende skadesrapport – du kan oprette én nu.</div>

    </form>
</div>

</body>
</html>
